#!/usr/bin/env bash

# Usage:
#
#     $ bin/compile <build-dir> <cache-dir> <env-path>

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BUILDPACK_DIR=`cd $(dirname $0); cd ..; pwd`

VENDOR_DIR=$BUILD_DIR/vendor
mkdir -p $VENDOR_DIR

# Download and install Google Cloud SDK (version 537.0.0)
wget https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-537.0.0-linux-x86_64.tar.gz -qO /tmp/google-cloud-sdk.tar.gz
tar -xzf /tmp/google-cloud-sdk.tar.gz -C $VENDOR_DIR
$VENDOR_DIR/google-cloud-sdk/install.sh --usage-reporting=false --path-update=false --bash-completion=false
rm -rf /tmp/google-cloud-sdk.tar.gz
rm -rf $VENDOR_DIR/google-cloud-sdk/.install/

# Copy .profile.d script for configuring gcloud
mkdir -p $BUILD_DIR/.profile.d
cp $BUILDPACK_DIR/profile.d/heroku-google-cloud.sh $BUILD_DIR/.profile.d

# Add gcloud to PATH
export PATH=$VENDOR_DIR/google-cloud-sdk/bin:$PATH

# Install kubectl
if [ -r "$ENV_DIR/INSTALL_KUBECTL" ]; then
    INSTALL_KUBECTL="$(cat "$ENV_DIR/INSTALL_KUBECTL")"
    if [ $INSTALL_KUBECTL == "true" ]; then
        gcloud components install kubectl --quiet
    fi
fi
